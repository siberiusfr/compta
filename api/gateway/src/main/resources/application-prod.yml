# Production profile configuration
spring:
  config:
    activate:
      on-profile: prod

  cloud:
    gateway.server.webflux:
      # ✅ Enable global filters
      # ✅ Global timeouts
      httpclient:
        connect-timeout: 5000 # 5 seconds
        response-timeout: 30s # 30 seconds
        pool:
          max-connections: 500
          acquire-timeout: 45000
      default-filters:
        # Rate limiting (requires Redis)
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 100 # tokens per second
            redis-rate-limiter.burstCapacity: 200 # max burst
            key-resolver: '#{@userKeyResolver}' # Rate limit per user

        # Remove hop-by-hop headers
        - RemoveRequestHeader=Cookie
        - RemoveRequestHeader=Set-Cookie

        # Add security headers (redondant avec SecurityHeadersFilter mais double sécurité)
        - AddResponseHeader=X-Content-Type-Options, nosniff
        - AddResponseHeader=X-Frame-Options, DENY
        - AddResponseHeader=X-XSS-Protection, 1; mode=block
        - AddResponseHeader=Strict-Transport-Security, max-age=31536000; includeSubDomains

# ⚠️ JWT secret MUST be provided via environment variable in production
# DO NOT use default value in production!
jwt:
  secret: ${JWT_SECRET} # ✅ No default value - will fail if not set
  expiration: ${JWT_EXPIRATION:3600000} # 1 hour default
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800000} # 7 days

# Production service URLs (use environment variables)
AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
AUTHZ_SERVICE_URL: ${AUTHZ_SERVICE_URL}
INVOICE_SERVICE_URL: ${INVOICE_SERVICE_URL}
EMPLOYEE_SERVICE_URL: ${EMPLOYEE_SERVICE_URL}

# ✅ Gateway URLs pour OpenAPI
gateway:
  url:
    prod: ${GATEWAY_URL:https://api.compta.tn}

# Disable Swagger in production
springdoc:
  swagger-ui:
    enabled: false
  api-docs:
    enabled: false

# Reduced logging in production
logging:
  level:
    root: WARN
    tn.compta.gateway: INFO
    org.springframework.security: INFO
    org.springframework.cloud.gateway: INFO
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss} %-5level [%thread] %logger{36} - [%X{requestId}] %msg%n'

# Hide sensitive actuator info
management:
  endpoint:
    health:
      show-details: when-authorized
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  prometheus:
    metrics:
      export:
        enabled: true

# Production CORS - ⚠️ IMPORTANT : À adapter selon vos domaines
cors:
  allowed-origins:
    - https://app.compta.tn
    - https://www.compta.tn
  max-age: 3600
