# Zitadel Production Configuration
# Uses a dedicated 'zitadel' database with SSL, TLS enabled, and secure defaults
# Zitadel manages its own schemas internally
# IMPORTANT: Replace all placeholder values before deploying!

services:
  # ==========================================
  # Zitadel Identity Provider (Production)
  # ==========================================
  zitadel:
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel:latest
    container_name: compta-zitadel
    command: start-from-init --masterkey "${ZITADEL_MASTERKEY:?ZITADEL_MASTERKEY is required}"
    environment:
      # External domain configuration (your public domain)
      ZITADEL_EXTERNALDOMAIN: ${ZITADEL_DOMAIN:?ZITADEL_DOMAIN is required}
      ZITADEL_EXTERNALPORT: ${ZITADEL_PORT:-443}
      ZITADEL_EXTERNALSECURE: "true"

      # TLS configuration
      ZITADEL_TLS_ENABLED: "true"
      ZITADEL_TLS_CERTPATH: /certs/cert.pem
      ZITADEL_TLS_KEYPATH: /certs/key.pem

      # Database configuration (PostgreSQL with SSL - dedicated zitadel database)
      ZITADEL_DATABASE_POSTGRES_HOST: ${POSTGRES_HOST:?POSTGRES_HOST is required}
      ZITADEL_DATABASE_POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: ${POSTGRES_ADMIN_USER:-postgres}
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: ${POSTGRES_ADMIN_PASSWORD:?POSTGRES_ADMIN_PASSWORD is required}
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: ${POSTGRES_SSL_MODE:-require}
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: ${ZITADEL_DB_PASSWORD:?ZITADEL_DB_PASSWORD is required}
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: ${POSTGRES_SSL_MODE:-require}

      # Login client configuration for Login V2
      ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH: /current-dir/login-client.pat
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED: ${ZITADEL_FORCE_PASSWORD_CHANGE:-true}
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME: login-client
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME: Automatically Initialized IAM_LOGIN_CLIENT
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE: '2030-01-01T00:00:00Z'

      # Login V2 configuration
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED: true
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI: https://${ZITADEL_DOMAIN}/ui/v2/login
      ZITADEL_OIDC_DEFAULTLOGINURLV2: https://${ZITADEL_DOMAIN}/ui/v2/login/login?authRequest=
      ZITADEL_OIDC_DEFAULTLOGOUTURLV2: https://${ZITADEL_DOMAIN}/ui/v2/login/logout?post_logout_redirect=
      ZITADEL_SAML_DEFAULTLOGINURLV2: https://${ZITADEL_DOMAIN}/ui/v2/login/login?samlRequest=

      # First instance configuration
      ZITADEL_FIRSTINSTANCE_ORG_NAME: ${ZITADEL_ORG_NAME:-COMPTA}
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: ${ZITADEL_ADMIN_USERNAME:?ZITADEL_ADMIN_USERNAME is required}
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: ${ZITADEL_ADMIN_PASSWORD:?ZITADEL_ADMIN_PASSWORD is required}

      # Security settings
      ZITADEL_DEFAULTINSTANCE_SECRETGENERATORS_PASSWORDSALTCOST: 14
      ZITADEL_DEFAULTINSTANCE_SECRETGENERATORS_CLIENTSECRETHASHER_HASHER_COST: 14

      # Session settings
      ZITADEL_DEFAULTINSTANCE_LOGINPOLICY_PASSWORDCHECKLIFETIME: "720h"
      ZITADEL_DEFAULTINSTANCE_LOGINPOLICY_EXTERNALLOGINCHECKLIFETIME: "720h"
      ZITADEL_DEFAULTINSTANCE_LOGINPOLICY_MFAINITMATCHLIFETIME: "720h"
      ZITADEL_DEFAULTINSTANCE_LOGINPOLICY_SECONDFACTORCHECKLIFETIME: "720h"
      ZITADEL_DEFAULTINSTANCE_LOGINPOLICY_MULTIFACTORCHECKLIFETIME: "720h"

      # Production log level
      ZITADEL_LOG_LEVEL: ${ZITADEL_LOG_LEVEL:-warn}

      # Telemetry (disable in production)
      ZITADEL_TELEMETRY_ENABLED: "false"

    healthcheck:
      test:
        - CMD
        - /app/zitadel
        - ready
      interval: 10s
      timeout: 60s
      retries: 5
      start_period: 10s
    user: "0"
    volumes:
      - ./data:/current-dir:delegated
      - ${ZITADEL_CERTS_PATH:-./certs}:/certs:ro
    ports:
      - "${ZITADEL_PORT:-8443}:8080"
      - "${ZITADEL_LOGIN_PORT:-3001}:3000"
    networks:
      - compta-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================
  # Zitadel Login V2 Service (Production)
  # ==========================================
  login:
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel-login:latest
    container_name: compta-zitadel-login
    environment:
      - ZITADEL_API_URL=http://localhost:8080
      - NEXT_PUBLIC_BASE_PATH=/ui/v2/login
      - ZITADEL_SERVICE_USER_TOKEN_FILE=/current-dir/login-client.pat
    network_mode: service:zitadel
    user: "0"
    volumes:
      - ./data:/current-dir:ro
    depends_on:
      zitadel:
        condition: service_healthy

networks:
  compta-network:
    external: true
    name: compta-network

# =============================================================================
# PRODUCTION DEPLOYMENT CHECKLIST
# =============================================================================
#
# 1. Generate a secure master key (32 characters):
#    openssl rand -base64 32 | head -c 32
#
# 2. Generate a secure password for zitadel DB user:
#    openssl rand -base64 24
#
# 3. Create .env.prod file with required variables:
#    ZITADEL_MASTERKEY=<your-32-char-master-key>
#    ZITADEL_DOMAIN=auth.yourdomain.com
#    ZITADEL_PORT=443
#    ZITADEL_LOGIN_PORT=3001
#    ZITADEL_ORG_NAME=COMPTA
#    ZITADEL_ADMIN_USERNAME=admin
#    ZITADEL_ADMIN_PASSWORD=<secure-password>
#    ZITADEL_DB_PASSWORD=<zitadel-db-password>
#    POSTGRES_HOST=<your-postgres-host>
#    POSTGRES_ADMIN_USER=postgres
#    POSTGRES_ADMIN_PASSWORD=<postgres-admin-password>
#    POSTGRES_SSL_MODE=require
#    ZITADEL_CERTS_PATH=./certs
#
# 4. Prepare TLS certificates in certs/ directory:
#    - cert.pem (certificate)
#    - key.pem (private key)
#
# 5. Create data directory:
#    mkdir -p data
#
# 6. Create the zitadel database in PostgreSQL:
#    psql -h $POSTGRES_HOST -U postgres -f init-db.sql
#
# 7. Start Zitadel:
#    docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
#
# 8. Access Zitadel Console: https://<ZITADEL_DOMAIN>/ui/console
#    Login: <ZITADEL_ADMIN_USERNAME>@<ZITADEL_ORG_NAME>.<ZITADEL_DOMAIN>
#
# =============================================================================
# SECURITY RECOMMENDATIONS
# =============================================================================
#
# - Use a managed PostgreSQL service with SSL enabled
# - Store secrets in a vault (HashiCorp Vault, AWS Secrets Manager, etc.)
# - Enable rate limiting at the reverse proxy level
# - Set up monitoring and alerting
# - Configure backup for PostgreSQL
# - Use a CDN for static assets
# - Enable audit logging
# - Configure ZITADEL_FORCE_PASSWORD_CHANGE=true for first login
#
